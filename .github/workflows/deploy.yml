name: üöÄ Deploy to Production

on:
  push:
    branches: ["production"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout Code
        uses: actions/checkout@v3

      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.8
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üß© Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      # Step 1: Clone or update repository in temporary folder
      - name: üîÑ Clone or Pull Repository
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          REPO_PATH=${{ secrets.SERVER_PATH }}/repository
          if [ -d \$REPO_PATH/.git ]; then
              cd \$REPO_PATH && git reset --hard && git pull origin production;
          else
              git clone -b production https://github.com/${{ github.repository }} \$REPO_PATH;
          fi
          "

      # Step 2: Sync files to project_root
      - name: üìÇ Sync Project Files
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          SRC=${{ secrets.SERVER_PATH }}/repository
          DST=${{ secrets.SERVER_PATH }}/project_root

          mkdir -p \$DST

          # Copy all files except .git and .env
          rsync -av --exclude='.git' --exclude='.env' \$SRC/ \$DST/
          "

      # Step 3: Run composer install
      - name: üß© Install Dependencies
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          cd ${{ secrets.SERVER_PATH }}/project_root
          php -d allow_url_fopen=On composer install --no-dev --optimize-autoloader
          "

      # Step 4: Run migrations & seeders
      - name: üóÑÔ∏è Migrate & Seed
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          cd ${{ secrets.SERVER_PATH }}/project_root
          php artisan migrate --force
          php artisan db:seed --force
          "

      # Step 5: Clear & Optimize Cache
      - name: ‚ö° Clear & Optimize
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          cd ${{ secrets.SERVER_PATH }}/project_root
          php artisan optimize:clear
          php artisan optimize
          "

      # Step 6: Copy public assets to public_html
      - name: üìÅ Copy Assets to public_html
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          PROJECT_PATH=${{ secrets.SERVER_PATH }}/project_root
          PUBLIC_PATH=${{ secrets.SERVER_PATH }}/public_html

          mkdir -p \$PUBLIC_PATH

          for folder in assets build metronic; do
            if [ -d \$PROJECT_PATH/public/\$folder ]; then
              cp -r \$PROJECT_PATH/public/\$folder \$PUBLIC_PATH/
              echo \"‚úÖ \$folder copied successfully\"
            else
              echo \"‚ö†Ô∏è \$folder folder not found\"
            fi
          done
          "
